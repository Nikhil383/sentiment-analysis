{% extends "base.html" %}

{% block content %}
  <section class="panel">
    <div id="status" class="status">
      {% if model_loaded %}
        <span class="ok">Model loaded ✅</span>
      {% else %}
        <span class="err">Model not loaded — check server logs ⚠️</span>
      {% endif %}
    </div>

    <label for="texts">Enter sentences (one per line):</label>
    <textarea id="texts" rows="8" placeholder="I loved this movie!\nI hated it..."></textarea>

    <div class="row">
      <button id="predictBtn">Predict</button>
      <button id="clearBtn" class="muted">Clear</button>
    </div>

    <h3>Results</h3>
    <div id="results"></div>
  </section>

  <script>
    const predictBtn = document.getElementById('predictBtn');
    const clearBtn = document.getElementById('clearBtn');
    const textsEl = document.getElementById('texts');
    const resultsEl = document.getElementById('results');

    predictBtn.addEventListener('click', async () => {
      const raw = textsEl.value.trim();
      if (!raw) {
        resultsEl.innerHTML = '<div class="info">Enter at least one sentence.</div>';
        return;
      }
      const lines = raw.split('\\n').map(s => s.trim()).filter(Boolean);
      resultsEl.innerHTML = '<div class="info">Running inference…</div>';

      try {
        const res = await fetch('/predict', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({texts: lines})
        });
        const data = await res.json();
        if (!res.ok) {
          resultsEl.innerHTML = `<div class="err">Error: ${data.error || JSON.stringify(data)}</div>`;
          return;
        }

        // show results as table
        let html = '<table class="results-table"><thead><tr><th>Text</th><th>Label</th><th>Prob(positive)</th></tr></thead><tbody>';
        for (let i = 0; i < lines.length; i++) {
          const label = data.labels[i] || '-';
          const p = (data.prob_positive && data.prob_positive[i]) ? data.prob_positive[i].toFixed(3) : '-';
          html += `<tr><td>${escapeHtml(lines[i])}</td><td>${label}</td><td>${p}</td></tr>`;
        }
        html += '</tbody></table>';
        resultsEl.innerHTML = html;
      } catch (err) {
        resultsEl.innerHTML = '<div class="err">Request failed — see console for details.</div>';
        console.error(err);
      }
    });

    clearBtn.addEventListener('click', () => {
      textsEl.value = '';
      resultsEl.innerHTML = '';
    });

    function escapeHtml(text) {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  </script>
{% endblock %}
